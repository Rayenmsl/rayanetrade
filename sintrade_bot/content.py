from __future__ import annotations

from typing import Dict, List, Optional

from .models import Lesson, QuizQuestion

LEVEL_ORDER = ["beginner", "intermediate", "advanced", "professional"]
LEVEL_LABELS = {
    "beginner": "المستوى 1 - مبتدئ",
    "intermediate": "المستوى 2 - متوسط",
    "advanced": "المستوى 3 - متقدم",
    "professional": "المستوى 4 - احترافي",
}

RISK_REMINDER = (
    "التداول مهارة تحتاج وقتًا للتطوير. الخسائر جزء طبيعي من التعلم. "
    "إدارة المخاطر الصحيحة أهم من عدد الصفقات الرابحة."
)

PREMIUM_LOCK_MESSAGE = (
    "هذا المستوى مقفول للمستخدم المجاني. يمكنني تقديم شرح تعليمي عام، "
    "لكن الأطر الكاملة والأنظمة المتقدمة ضمن محتوى البريميوم."
)

LESSONS: Dict[str, List[Lesson]] = {
    "beginner": [
        Lesson(
            lesson_id="L1-01",
            level="beginner",
            title="ما هو التداول وما ليس تداولًا",
            objective="فهم أن التداول مهارة احتمالية وليس زر دخل مضمون.",
            bullet_points=[
                "التداول هو شراء وبيع الأصول للاستفادة من حركة السعر.",
                "كل صفقة فيها عدم يقين ولا توجد إشارة مضمونة.",
                "أول أولوية للمتداول هي حماية رأس المال لا الربح السريع.",
                "المتداول المنضبط يتبع خطة واضحة بدل القرارات العاطفية.",
            ],
            example=(
                "مثال: دخلت شراء على BTC من 60,000 وحددت وقف خسارة عند 58,800، "
                "فإذا بطلت الفكرة تقبل خسارة صغيرة مخططة."
            ),
            quiz=[
                QuizQuestion(
                    prompt="أي عبارة أدق عن التداول؟",
                    options={
                        "A": "التداول يضمن الربح إذا كانت الإشارة قوية.",
                        "B": "التداول احتمالي ويحتاج إدارة مخاطر صارمة.",
                        "C": "أي خسارة تعني أن الاستراتيجية فاشلة دائمًا.",
                        "D": "الرافعة تلغي المخاطر إذا استُخدمت جيدًا.",
                    },
                    answer="B",
                    explanation="العقلية الصحيحة: لا يقين في السوق، لذا إدارة المخاطر أساسية.",
                ),
                QuizQuestion(
                    prompt="ما الذي يجب أن يأتي أولًا في تطويرك؟",
                    options={
                        "A": "مضاعفة الرافعة",
                        "B": "توقع كل حركة بالسوق",
                        "C": "حماية رأس المال والانضباط",
                        "D": "الدخول في كل اختراق",
                    },
                    answer="C",
                    explanation="حماية رأس المال تبقيك في السوق وقتًا كافيًا لبناء مهارة حقيقية.",
                ),
            ],
        ),
        Lesson(
            lesson_id="L1-02",
            level="beginner",
            title="السبوت مقابل الفيوتشرز والرافعة والتصفية",
            objective="فهم الفروقات الأساسية بين السبوت والفيوتشرز قبل استخدام الرافعة.",
            bullet_points=[
                "في السبوت تمتلك الأصل مباشرة ولا يوجد نظام تصفية.",
                "في الفيوتشرز تتداول عقدًا ويمكنك استخدام الهامش والرافعة.",
                "الرافعة تضخم الربح والخسارة بنفس الوقت.",
                "التصفية تحدث عندما لا يكفي الهامش لتحمل حركة السعر ضدك.",
            ],
            example=(
                "مثال: عند 10x، حركة 1% عكسك قد تعادل تقريبًا 10% على هامشك. "
                "بدون وقف خسارة يزيد خطر التصفية بسرعة."
            ),
            quiz=[
                QuizQuestion(
                    prompt="ما التأثير الأساسي للرافعة؟",
                    options={
                        "A": "تقليل المخاطر تلقائيًا",
                        "B": "زيادة الربح فقط",
                        "C": "تضخيم الربح والخسارة",
                        "D": "منع التصفية",
                    },
                    answer="C",
                    explanation="الرافعة تزيد التعرض في الاتجاهين، لذلك الانضباط أهم.",
                ),
                QuizQuestion(
                    prompt="أي نوع تداول يرتبط مباشرة بخطر التصفية؟",
                    options={
                        "A": "السبوت فقط",
                        "B": "الفيوتشرز بالهامش",
                        "C": "لا شيء منهما",
                        "D": "أي استثمار طويل المدى",
                    },
                    answer="B",
                    explanation="التصفية مرتبطة بالعقود ذات الهامش مثل الفيوتشرز.",
                ),
            ],
        ),
        Lesson(
            lesson_id="L1-03",
            level="beginner",
            title="الدعم والمقاومة وأساسيات الشموع",
            objective="تحديد مناطق الهيكل الأساسية وفهم سلوك الشموع بشكل صحيح.",
            bullet_points=[
                "الدعم منطقة قد يظهر فيها طلب.",
                "المقاومة منطقة قد يظهر فيها عرض.",
                "الشمعة تعرض الافتتاح والأعلى والأدنى والإغلاق لفترة زمنية.",
                "الشمعة المفردة وحدها ضعيفة؛ السياق أهم من النمط المنعزل.",
            ],
            example=(
                "مثال: إذا رفض السعر منطقة 62,000 عدة مرات، قد تعمل كمقاومة حتى يحدث اختراق مؤكد."
            ),
            quiz=[
                QuizQuestion(
                    prompt="منطقة المقاومة غالبًا هي مكان:",
                    options={
                        "A": "تفوق المشترين دائمًا",
                        "B": "ظهور ضغط بيعي متكرر",
                        "C": "استحالة حدوث تصفية",
                        "D": "عدم تغير الاتجاه أبدًا",
                    },
                    answer="B",
                    explanation="المقاومة منطقة يتكرر عندها البيع أو جني الأرباح.",
                ),
                QuizQuestion(
                    prompt="أفضل طريقة لقراءة الشموع هي:",
                    options={
                        "A": "الاعتماد على شمعة واحدة",
                        "B": "تجاهل هيكل السوق",
                        "C": "قراءة الشموع مع الاتجاه والمستويات",
                        "D": "الدخول مع كل ذيل شمعة",
                    },
                    answer="C",
                    explanation="السياق يحسن دقة القرار أكثر من أي شكل شمعة منفرد.",
                ),
            ],
        ),
    ],
    "intermediate": [
        Lesson(
            lesson_id="L2-01",
            level="intermediate",
            title="الاتجاهات ومراحل السوق",
            objective="تصنيف حالة السوق قبل التفكير في أي دخول.",
            bullet_points=[
                "الاتجاه الصاعد: قمم أعلى وقيعان أعلى.",
                "الاتجاه الهابط: قمم أدنى وقيعان أدنى.",
                "التذبذب: حركة جانبية بين دعم ومقاومة.",
                "الاستراتيجية الناجحة يجب أن توافق مرحلة السوق.",
            ],
            example=(
                "مثال: داخل نطاق واضح، دخولات تتبع الاتجاه من منتصف النطاق غالبًا تكون ضعيفة الجودة."
            ),
            quiz=[
                QuizQuestion(
                    prompt="ما العلامة الأساسية للاتجاه الصاعد؟",
                    options={
                        "A": "قمم أدنى وقيعان أدنى",
                        "B": "قمم أعلى وقيعان أعلى",
                        "C": "تذبذب ثابت فقط",
                        "D": "اختراقات كاذبة دائمًا",
                    },
                    answer="B",
                    explanation="تسلسل القمم والقيعان الصاعدة يوضح بنية صاعدة.",
                ),
                QuizQuestion(
                    prompt="لماذا نحدد مرحلة السوق قبل الدخول؟",
                    options={
                        "A": "لزيادة عدد الصفقات",
                        "B": "لإلغاء وقف الخسارة",
                        "C": "لمواءمة الاستراتيجية مع السياق",
                        "D": "لإزالة عدم اليقين نهائيًا",
                    },
                    answer="C",
                    explanation="توافق الخطة مع السياق يقلل الدخول العشوائي ويحسن الثبات.",
                ),
            ],
        ),
        Lesson(
            lesson_id="L2-02",
            level="intermediate",
            title="الاختراق والاختراق الكاذب ومفهوم السيولة",
            objective="التمييز بين الاختراق الحقيقي ومصيدة السيولة حول المستويات المهمة.",
            bullet_points=[
                "جودة الاختراق تتحسن مع الحجم والثبات وإعادة الاختبار.",
                "الاختراق الكاذب غالبًا يسحب قممًا أو قيعانًا واضحة ثم يعكس.",
                "السيولة تتجمع عادة فوق القمم المتساوية وتحت القيعان المتساوية.",
                "انتظر التأكيد بدل الدخول الاندفاعي.",
            ],
            example=(
                "مثال: السعر كسر قممًا متساوية ثم عاد وأغلق داخل النطاق؛ هذا سلوك اختراق كاذب شائع."
            ),
            quiz=[
                QuizQuestion(
                    prompt="الاختراق الكاذب غالبًا يبدو كالتالي:",
                    options={
                        "A": "اختراق نظيف وثبات مباشر",
                        "B": "عدم اقتراب من أي مستوى",
                        "C": "سحب مستوى ثم انعكاس سريع",
                        "D": "استمرار اتجاه مضمون",
                    },
                    answer="C",
                    explanation="كثير من الاختراقات الكاذبة تسحب السيولة قبل الانعكاس.",
                ),
                QuizQuestion(
                    prompt="أفضل تصرف بعد كسر مستوى مهم هو:",
                    options={
                        "A": "الدخول مباشرة بلا خطة",
                        "B": "طلب تأكيد مع نقطة إبطال واضحة",
                        "C": "رفع الرافعة فورًا",
                        "D": "إلغاء وقف الخسارة",
                    },
                    answer="B",
                    explanation="التأكيد مع إبطال واضح يجعل القرار منضبطًا وقابلًا للتقييم.",
                ),
            ],
        ),
        Lesson(
            lesson_id="L2-03",
            level="intermediate",
            title="العائد إلى المخاطرة وحجم الصفقة",
            objective="استخدام الحسابات لضبط الخسارة والحفاظ على استمرارية الأداء.",
            bullet_points=[
                "نسبة العائد إلى المخاطرة تقارن الربح المحتمل بالخسارة المحتملة.",
                "حجم الصفقة يُبنى على مسافة الوقف وحد المخاطرة.",
                "الحد الشائع للمخاطرة يكون غالبًا بين 0.5% و2% للصفقة.",
                "ثبات حجم المخاطرة يقلل التذبذب العاطفي.",
            ],
            example=(
                "مثال: حسابك 5,000 دج وحد مخاطرتك 1%، إذن خسارتك القصوى 50 دج. "
                "إذا كان الوقف 2% فحجم الصفقة يجب أن يجعل 2% = 50 دج."
            ),
            quiz=[
                QuizQuestion(
                    prompt="إذا كانت المخاطرة ثابتة لكل صفقة، فحجم الصفقة يجب أن:",
                    options={
                        "A": "يبقى ثابتًا مهما كانت مسافة الوقف",
                        "B": "يتغير حسب مسافة الوقف",
                        "C": "يكون دائمًا بأقصى حجم",
                        "D": "يعتمد فقط على الرافعة",
                    },
                    answer="B",
                    explanation="حجم الصفقة يتكيف مع الوقف ليبقى مقدار المخاطرة ثابتًا.",
                ),
                QuizQuestion(
                    prompt="لماذا نسبة مخاطرة ثابتة مهمة؟",
                    options={
                        "A": "لأنها تضمن الأرباح",
                        "B": "لأنها تمنع الخسارة تمامًا",
                        "C": "لأنها تقلل السحب وتحمي الاستمرارية",
                        "D": "لأنها تغني عن الاستراتيجية",
                    },
                    answer="C",
                    explanation="ضبط المخاطرة يحافظ على رأس المال ويقلل القرارات العاطفية.",
                ),
            ],
        ),
    ],
    "advanced": [
        Lesson(
            lesson_id="L3-01",
            level="advanced",
            title="مفاهيم السيولة وتحوّل البنية (نظرة تعليمية)",
            objective="تعلم لغة التحليل المتقدم بشكل تعليمي غير ادعائي.",
            bullet_points=[
                "السوق يبحث غالبًا عن السيولة قبل الحركة الاتجاهية.",
                "تحول البنية يساعد على رصد تغير الزخم المحتمل.",
                "مناطق الكتل السعرية هي فرضيات تحتاج تأكيدًا من السياق.",
                "التوافق بين الأطر الزمنية يرفع جودة التنفيذ.",
            ],
            example=(
                "مثال: اتجاه صاعد على إطار أعلى + سحب سيولة أسفل دعم + تحول بنية على إطار أدنى "
                "قد يبني فكرة شراء منظمة."
            ),
            quiz=[
                QuizQuestion(
                    prompt="في التحليل المتقدم، أين تتجمع السيولة غالبًا؟",
                    options={
                        "A": "في مناطق عشوائية فقط",
                        "B": "حول القمم والقيعان الواضحة",
                        "C": "هي غير مهمة في القرار",
                        "D": "هي نقطة انعكاس مضمونة دائمًا",
                    },
                    answer="B",
                    explanation="السيولة عادة تتمركز حول مستويات ظاهرة للغالبية.",
                )
            ],
            premium_only=False,
        ),
        Lesson(
            lesson_id="L3-02",
            level="advanced",
            title="طبقات إدارة المخاطر ومراجعة الأداء",
            objective="بناء ثبات أعمق عبر حدود السحب ومراجعة التنفيذ بشكل دوري.",
            bullet_points=[
                "حدد حد سحب يومي وأسبوعي لا تتجاوزه.",
                "صنّف الصفقات حسب الجودة (A/B/C) وقارن النتائج.",
                "راجع انحرافاتك النفسية عن الخطة المكتوبة.",
                "حسّن العملية قبل التفكير في زيادة الحجم.",
            ],
            example=(
                "مثال: إذا وصل السحب الأسبوعي إلى -4R، توقف عن التداول وابدأ مراجعة منهجية بدل مطاردة التعويض."
            ),
            quiz=[
                QuizQuestion(
                    prompt="ماذا يجب أن تفعل عند تجاوز حد السحب المحدد؟",
                    options={
                        "A": "مضاعفة الحجم لتعويض الخسارة",
                        "B": "التوقف مؤقتًا ومراجعة العملية",
                        "C": "تجاهل الحد إذا كانت القناعة قوية",
                        "D": "تبديل الاستراتيجية يوميًا",
                    },
                    answer="B",
                    explanation="حدود السحب تحمي رأس المال والانضباط النفسي.",
                )
            ],
            premium_only=True,
        ),
    ],
    "professional": [
        Lesson(
            lesson_id="L4-01",
            level="professional",
            title="مخطط الاستراتيجية الاحترافية",
            objective="دمج السياق وإشارة الدخول ونموذج المخاطر والمراجعة في نظام واحد.",
            bullet_points=[
                "حدد سوقًا واضحًا ونوافذ تنفيذ ثابتة.",
                "استخدم قائمة فحص قبل كل صفقة.",
                "طبّق إدارة صفقة وخروجًا مبنيين على قواعد.",
                "تابع التوقع الرياضي وتذبذب النتائج شهريًا.",
            ],
            example=(
                "مثال: لا تتداول إلا صفقات A خلال جلسات محددة، بمخاطرة 1% ثابتة، "
                "مع إكمال سجل مراجعة بعد كل صفقة."
            ),
            quiz=[
                QuizQuestion(
                    prompt="الخطة الاحترافية يجب أن تكون:",
                    options={
                        "A": "عاطفية ومتغيرة",
                        "B": "قابلة للقياس ومبنية على قواعد",
                        "C": "تتغير بالكامل كل يوم",
                        "D": "معتمدة على مؤشر واحد فقط",
                    },
                    answer="B",
                    explanation="الاحتراف يعني عملية قابلة للتكرار والقياس.",
                )
            ],
            premium_only=True,
        ),
        Lesson(
            lesson_id="L4-02",
            level="professional",
            title="التخطيط لنمو رأس المال طويل المدى",
            objective="توسيع الأداء تدريجيًا بناءً على بيانات ثابتة واستقرار المخاطر.",
            bullet_points=[
                "زد الحجم فقط بعد ثبات إحصائي واضح.",
                "افصل بين رأس مال المعيشة ورأس مال التداول.",
                "اعتمد زيادات مرحلية مع حدود سحب صارمة.",
                "احمِ تركيزك الذهني بروتين واضح وحدود عملية.",
            ],
            example=(
                "مثال: ارفع المخاطرة من 0.75% إلى 1% فقط بعد 3 أشهر مستقرة مع سحب مضبوط وتنفيذ نظيف."
            ),
            quiz=[
                QuizQuestion(
                    prompt="أفضل وقت لزيادة المخاطرة هو:",
                    options={
                        "A": "بعد أسبوع ربح واحد",
                        "B": "عند الشعور بثقة عالية",
                        "C": "بعد ثبات موثق لفترة كافية",
                        "D": "بناءً على إشارات السوشال ميديا",
                    },
                    answer="C",
                    explanation="التوسيع يجب أن يعتمد على بيانات لا على الانفعال.",
                )
            ],
            premium_only=True,
        ),
    ],
}

DAILY_CHALLENGES = [
    {
        "prompt": (
            "تحدي اليوم: بيتكوين يتحرك داخل نطاق 4 ساعات بين 61,800 دج و63,200 دج. "
            "السعر حاليًا 62,950 دج قرب أعلى النطاق. ما تحيزك ولماذا؟ "
            "اذكر نقطة إبطال الفكرة والحد الأقصى للمخاطرة لكل صفقة."
        ),
        "expected_keywords": ["نطاق", "إبطال", "مخاطرة", "تأكيد"],
    },
    {
        "prompt": (
            "تحدي اليوم: إيثيريوم كوّن قمة أدنى على إطار الساعة بعد اختراق ضعيف. "
            "كيف تفرق بين الاستمرار والاختراق الكاذب قبل الدخول؟"
        ),
        "expected_keywords": ["هيكل", "سيولة", "وقف", "تأكيد"],
    },
    {
        "prompt": (
            "تحدي اليوم: سولانا في اتجاه صاعد على 4 ساعات لكن مع تصحيح على 15 دقيقة. "
            "اشرح خطة متعددة الأطر الزمنية مع إدارة مخاطر واضحة."
        ),
        "expected_keywords": ["اتجاه", "إطار", "دخول", "مخاطرة"],
    },
]

SIMULATION_SCENARIOS = [
    {
        "symbol": "BTCDZD",
        "entry": 64200.0,
        "support": 63650.0,
        "resistance": 64880.0,
    },
    {
        "symbol": "ETHDZD",
        "entry": 3475.0,
        "support": 3410.0,
        "resistance": 3548.0,
    },
    {
        "symbol": "SOLDZD",
        "entry": 152.4,
        "support": 149.6,
        "resistance": 156.9,
    },
]


def lessons_for_user(level: str, access: str) -> List[Lesson]:
    lessons = LESSONS.get(level, [])
    if access == "premium":
        return lessons
    return [lesson for lesson in lessons if not lesson.premium_only]


def level_label(level: str) -> str:
    return LEVEL_LABELS.get(level, level.title())


def next_level(level: str) -> Optional[str]:
    if level not in LEVEL_ORDER:
        return None
    index = LEVEL_ORDER.index(level)
    if index == len(LEVEL_ORDER) - 1:
        return None
    return LEVEL_ORDER[index + 1]
